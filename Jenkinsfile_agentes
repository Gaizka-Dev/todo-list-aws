pipeline {
   agent any
   options { skipDefaultCheckout(true) }
   environment {
      GIT_TOKEN = credentials('GIT_HUB_TOKEN')
   }

   stages {
      stage('Get Code') {
         agent {label 'agente1'}
         steps {
            sh 'hostname'
            echo WORKSPACE
            checkout scmGit(
               branches: [[ name: "develop" ]],
               userRemoteConfigs: [[ url: 'https://github.com/Gaizka-Dev/todo-list-aws' ]]
            )
            stash name:'code', includes:'**'
        }
      }

      stage('Static') {
         agent {label 'agente1'}
         steps {
            sh 'hostname'
            echo WORKSPACE
            sh 'flake8 --exit-zero --format=pylint src > flake8.out'
            recordIssues(
               tools: [flake8(name: 'Flake8.out', pattern: 'flake8.out')])
         }
      }

      stage('Security') {
         agent {label 'agente1'}
         steps {
            sh 'hostname'
            echo WORKSPACE
            sh '''
               bandit \
                  --recursive src/ \
                  --format custom \
                  --output bandit.out \
                  --msg-template "{abspath}:{line}: [{test_id}] {msg}"
            '''
            recordIssues(
               sourceCodeRetention: 'LAST_BUILD',
               tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')])
         }
      }

      stage('Deploy'){
         agent {label 'agente2'}
         steps {
            unstash name:'code'
            script {
               env.BUCKET_NAME = sh(
                  script: 'echo jenkins-sam-bucket-$(date +%s)',
                  returnStdout: true
               ).trim()
            }
            echo "$BUCKET_NAME"
            sh '''
               sam build
               sam validate --region us-east-1

               aws s3 mb s3://$BUCKET_NAME --region us-east-1
            
               sam deploy \
                  --config-env staging \
                  --s3-bucket $BUCKET_NAME
            '''
         }
      }

      stage('Rest Test'){
         agent {label 'agente2'}
         steps {
            sh 'hostname'
            echo WORKSPACE
            script{
               env.BASE_URL = sh(
                  script: '''
                     aws cloudformation \
                        describe-stacks \
                        --stack-name todo-list-aws-staging \
                        --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' \
                        --region us-east-1 \
                        --output text
                  ''',
                  returnStdout: true).trim()
            }
            echo "$BASE_URL"

            sh '''
               export BASE_URL=$BASE_URL
               export PYTHONPATH=$PYTHONPATH:$WORKSPACE
               pytest --junitxml=result-integration.xml ./test/integration/todoApiTest.py
            '''
            junit 'result-integration.xml'

            sh 'aws s3 rb s3://$BUCKET_NAME --force'
         }
         post {
            cleanup {
               deleteDir()
            }
         }
      }

      stage('Promote'){
         agent {label 'agente1'}
         steps{
            sh '''
               git checkout master
               git config merge.ours.driver true
               git pull
               git merge origin/develop

               git remote set-url origin https://${GIT_TOKEN}@github.com/Gaizka-Dev/todo-list-aws.git
               git push origin master
            '''
         }
         post {
            cleanup {
               deleteDir()
            }
         }
      }
   }
}

